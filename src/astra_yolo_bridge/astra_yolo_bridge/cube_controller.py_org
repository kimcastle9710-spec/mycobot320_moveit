#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from rclpy.action import ActionClient
# [ìˆ˜ì •] Pose ì¶”ê°€ ì„í¬íŠ¸
from geometry_msgs.msg import PoseStamped, Point, Quaternion, Pose 
from moveit_msgs.action import MoveGroup
from moveit_msgs.msg import Constraints, JointConstraint, PositionConstraint, OrientationConstraint, BoundingVolume
from shape_msgs.msg import SolidPrimitive
from tf2_ros import Buffer, TransformListener
import time

class CubeController(Node):
    def __init__(self):
        super().__init__('cube_controller')
        self.tf_buffer = Buffer()
        self.tf_listener = TransformListener(self.tf_buffer, self)

        self._action_client = ActionClient(self, MoveGroup, 'move_action')

        self.get_logger().info("Waiting for MoveGroup action server...")
        self._action_client.wait_for_server()
        self.get_logger().info("MoveGroup Ready!")

        # 5ì´ˆ í›„ ì´ë™
        self.timer = self.create_timer(5.0, self.move_to_cube)

    # def move_to_cube(self):
    #     self.timer.cancel()
        
    #     # 1. íë¸Œ ìœ„ì¹˜ ì¡°íšŒ
    #     try:
    #         trans = self.tf_buffer.lookup_transform('base', 'cube_target', rclpy.time.Time())
    #     except Exception as e:
    #         self.get_logger().error(f"Cube Not Found: {e}")
    #         return

    #     x = trans.transform.translation.x
    #     y = trans.transform.translation.y
    #     z = trans.transform.translation.z + 0.08 # 8cm ìœ„ (ì°ì§€ ì•Šê²Œ ì¡°ì‹¬)

    #     self.get_logger().warn(f"ğŸš€ Goal: X={x:.2f}, Y={y:.2f}, Z={z:.2f}")
    def move_to_cube(self):
        # [ìˆ˜ì •] íƒ€ì´ë¨¸ë¥¼ ë°”ë¡œ ë„ì§€ ì•ŠìŠµë‹ˆë‹¤! ì„±ê³µí•  ë•Œë§Œ ë•ë‹ˆë‹¤.
        
        # 1. íë¸Œ ìœ„ì¹˜ ì¡°íšŒ
        try:
            # íƒ€ì„ì•„ì›ƒì„ 0.5ì´ˆ ì¤˜ì„œ ê¸°ë‹¤ë¦¬ê²Œ í•¨
            trans = self.tf_buffer.lookup_transform(
                'base', 'cube_target', rclpy.time.Time(),
                timeout=rclpy.duration.Duration(seconds=0.5)
            )
        except Exception as e:
            # [ìˆ˜ì •] ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ ë¡œê·¸ ì°ê³ , ë‹¤ìŒ íƒ€ì´ë¨¸ ì£¼ê¸°(1ì´ˆ ë’¤)ì— ë‹¤ì‹œ ì‹œë„!
            self.get_logger().warn("Waiting for cube... (Place cube in front of camera)")
            return 

        # --- ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ íë¸Œ ì°¾ì€ ê²ƒì„! ---
        self.timer.cancel() # [ì¤‘ìš”] ì´ì œì„œì•¼ íƒ€ì´ë¨¸ë¥¼ ë•ë‹ˆë‹¤ (í•œ ë²ˆë§Œ ì›€ì§ì´ê¸° ìœ„í•´)

        x = trans.transform.translation.x
        y = trans.transform.translation.y
        z = trans.transform.translation.z + 0.20 # 8cm ìœ„
        self.get_logger().info(f"âœ… Target Found! ğŸš€ Goal: X={x:.2f}, Y={y:.2f}, Z={z:.2f}")
       
        # 2. ëª©í‘œ ë©”ì‹œì§€ ìƒì„±
        goal_msg = MoveGroup.Goal()
        goal_msg.request.workspace_parameters.header.frame_id = 'base'
        goal_msg.request.workspace_parameters.min_corner.x = -1.0
        goal_msg.request.workspace_parameters.min_corner.y = -1.0
        goal_msg.request.workspace_parameters.min_corner.z = -1.0
        goal_msg.request.workspace_parameters.max_corner.x = 1.0
        goal_msg.request.workspace_parameters.max_corner.y = 1.0
        goal_msg.request.workspace_parameters.max_corner.z = 1.0
        
        goal_msg.request.group_name = 'arm'
        goal_msg.request.num_planning_attempts = 10
        goal_msg.request.allowed_planning_time = 5.0
        goal_msg.request.max_velocity_scaling_factor = 0.1
        goal_msg.request.max_acceleration_scaling_factor = 0.1

        # ìœ„ì¹˜ ì œì•½ ì¡°ê±´ ì„¤ì •
        pcm = PositionConstraint()
        pcm.header.frame_id = 'base'
        pcm.link_name = 'link6'
        pcm.constraint_region.primitives = [SolidPrimitive(type=SolidPrimitive.SPHERE, dimensions=[0.01])]
        
        # [ìˆ˜ì •ëœ ë¶€ë¶„] Pose()ë¥¼ ì˜¬ë°”ë¥´ê²Œ ìƒì„±
        target_pose = Pose()
        target_pose.position.x = x
        target_pose.position.y = y
        target_pose.position.z = z
        # ë°©í–¥ì€ ì˜ë¯¸ ì—†ì§€ë§Œ ì´ˆê¸°í™” (w=1.0)
        target_pose.orientation.w = 1.0
        
        pcm.constraint_region.primitive_poses = [target_pose]
        pcm.weight = 1.0

        # ë°©í–¥ ì œì•½ ì¡°ê±´ ì„¤ì • (ì•„ë˜ ë³´ê¸°)
        ocm = OrientationConstraint()
        ocm.header.frame_id = 'base'
        ocm.link_name = 'link6'
        # ê·¸ë¦¬í¼ê°€ ë°”ë‹¥ì„ ë³´ëŠ” ë°©í–¥ (ë¡œë´‡ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ, ì¼ë‹¨ ê¸°ë³¸ê°’)
        ocm.orientation = Quaternion(x=1.0, y=0.0, z=0.0, w=0.0)
        ocm.absolute_x_axis_tolerance = 0.5
        ocm.absolute_y_axis_tolerance = 0.5
        ocm.absolute_z_axis_tolerance = 3.14
        ocm.weight = 1.0

        goal_msg.request.goal_constraints.append(Constraints(position_constraints=[pcm], orientation_constraints=[ocm]))

        # 3. ì „ì†¡
        self.get_logger().info("Sending goal...")
        self._send_goal_future = self._action_client.send_goal_async(goal_msg)
        self._send_goal_future.add_done_callback(self.goal_response_callback)

    def goal_response_callback(self, future):
        goal_handle = future.result()
        if not goal_handle.accepted:
            self.get_logger().error('Goal rejected :(')
            return
        self.get_logger().info('Goal accepted! Moving...')
        self._get_result_future = goal_handle.get_result_async()
        self._get_result_future.add_done_callback(self.get_result_callback)

    def get_result_callback(self, future):
        result = future.result().result
        if result.error_code.val == 1: # SUCCESS
            self.get_logger().info('ğŸ‰ Arrival Complete!')
        else:
            self.get_logger().error(f'âŒ Failed with error code: {result.error_code.val}')

def main(args=None):
    rclpy.init(args=args)
    node = CubeController()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()